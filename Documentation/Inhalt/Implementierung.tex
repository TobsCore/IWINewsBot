\chapter{Implementierung}
Nachdem nun die erwarteten Funktionen festgelegt sind, soll in diesem Kapitel die genauere Implementierung vorgestellt werden. Hierbei wird auch auf eine mögliche Erweiterbarkeit des Bots eingegangen.

Der Source Code des Bots ist auf Github über die Adresse \url{https://github.com/TobsCore/IWINewsBot} zu finden. Von dort aus kann der Code über den folgenden Befehl geladen werden.

\begin{lstlisting}
git clone https://github.com/TobsCore/IWINewsBot
\end{lstlisting}

In dem geladenen Ordner \texttt{IWINewsBot} befinden sich dabei die folgenden drei Ordner: \texttt{src}, \texttt{project} und \texttt{Documentation}. In \texttt{src/} sind die Dateien für den Bot enthalten, in \texttt{project/} befinden sich Informationen zu dem SBT-Projekt und in \texttt{Documentation} sind die Quelldateien für diese Dokumentation enthalten.

Damit der Bot korrekt starten kann, ist ein Token notwendig, hierzu legt man im Root-Ordner die Datei \texttt{bot.token} an und speichert in dieser Datei das vom BotFather generierte Token. Der Bot wird diese Datei dann nutzen, um sich zu verfizieren. Aus Sicherheitsgründen ist das Token nicht im Repository gespeichert.

\section{Scala und das Scala Build Tool}
Es wurde entschieden, den Bot in Scala zu programmieren, da dies eine interessante Programmiersprache ist, mit der man als Studierender nicht viele Berührungspunkte hat. Scala bietet durch die Objektorientierung vertraute Konzepte, jedoch sind viele Konzepte der funktionalen Programmierung in der Sprache vorhanden.

Um das Projekt zuverlässig bauen zu können und Abhängigkeiten zu verwalten, wird das Scala-Build-Tool (kurz \emph{SBT}) eingesetzt. Dieses Build-Tool gilt als Standard-Build-Tool für Scala Projekte. Um das Projekt besser kennen lernen zu können, soll an dieser Stelle die \texttt{build.sbt} des Projekts gezeigt werden, anhand derer SBT vorgestellt werden soll.

\lstinputlisting{build.sbt}

Am Anfang der Datei werden Informationen zu dem Projekt festgelegt, wie der Name und die Version. Außerdem kann an dieser Stelle die Scala-Version festgelegt werden.

Im Anschluss werden die Scala-Abhängigkeiten verwaltet. Wie man feststellt setzt der Telegram-Bot Bibliotheken wie \emph{Scala Test}, \emph{Telegrambot4s} und die Logging-Engine \emph{Logback} ein. Diese Abhängigkeiten werden über den \texttt{+=} an \texttt{libraryDependencies} angehängt.

Außerdem kann festgelegt werden, in welcher Datei sich die Main-Methode befindet, also die Methode, mit der das Programm gestartet werden soll. Wie man an der \texttt{build.sbt} erkennt, befindet sich diese in der Klasse \texttt{IWINewsBot} und ist im Package \texttt{hska\allowbreak.iwi\allowbreak.telegramBot}.

Außerdem wurden noch ein paar Regeln festgelegt, die die Benutzung vereinfachen. Diese sind am Ende der Datei definiert.

\subsection{Kompilieren und Fat-Jar Generierung}
Um SBT nutzen zu können, muss dies installiert sein. Interessant ist, dass Scala nicht auf dem Computer installiert sein muss, es kann auch nachträglich von SBT bezogen und installiert werden. Um das Projekt zu kompilieren, wird im Terminal in den Projektorder navigiert. Folgender Befehl lässt sich dann ausführen:

\begin{lstlisting}[language=bash]
> sbt
\end{lstlisting}

Dadurch startet sich ein SBT-Server. Über diesen Server kann dann das Projekt einfach kompiliert und gestartet werden.

\begin{lstlisting}[language=bash]
sbt:IWINewsBot> compile
\end{lstlisting}

\begin{lstlisting}[language=bash]
sbt:IWINewsBot> run
\end{lstlisting}

Da einige Klassen auch durch Unit-Tests getestet werden, kann dies auch direkt über den SBT-Server gestartet werden (mittels \texttt{test}). Der SBT-Server kann über \texttt{exit} beendet werden. Die Nutzung des Servers ist dahingehend sinnvoll, dass viele Dateien gecached werden können und das Projekt nicht jedes Mal neu geladen werden muss. Natürlich ist es auch möglich, das Projekt zu kompilieren, ohne den SBT-Server zu starten. Man kann aus der Kommandozeile auch folgendes eingeben:

\begin{lstlisting}[language=bash]
> sbt compile
\end{lstlisting}

Um das Programm dann jedoch auf einen Server zu spielen und dort zu starten, ist es sinnvoll, eine ausführbare Datei zu haben. Scala erzeugt JVM-Code, also gilt es eine \texttt{JAR}-Datei zu generieren. Um dieses JAR auf beliebigen Rechnern lauffähig zu machen, also auch auf Computern und Servern, die neben der JVM kein Scala installiert haben und zugleich auch alle Abhängigkeiten dazu zu packen, ist die Generierung eines sogenannten Fat-JARs notwendig.

Über das \emph{Assembly}-Plugin kann man genau dies umsetzen. Wenn man SBT gestartet hat, reicht die Ausführung des folgenden Befehls:

\begin{lstlisting}[language=bash]
> sbt assembly
\end{lstlisting}

Hierdurch wird das Programm \texttt{IWINewsBot\allowbreak-assembly\allowbreak-0.4\allowbreak.jar} in dem Ordner \texttt{target\allowbreak/scala-2.12/} generiert. Navigiert man in diesen Ordner, kann das Programm dann durch Ausführung des Befehls \texttt{java -jar IWINewsBot-assembly-0.4.jar} der Bot gestartet werden.

\textbf{Wichtig:} Damit der Bot starten kann, ist es absolut notwendig, dass in dem selben Ordner die \texttt{bot.token}-Datei mit dem validen Token für den Bot liegt. Man müsste also die \texttt{bot.token}-Datei in den Ordner \texttt{./target/scala-2.12/} kopieren, damit man die JAR-Datei erfolgreich ausführen kann.

\subsection{Scalafmt}
Um einen einheitlichen Code zu schreiben wird das Scalafmt\footnote{Siehe \url{http://scalameta.org/scalafmt/}}-Tool benutzt. Hierbei kann eine Konfiguration benutzt werden, um eigene Regeln festzulegen, ansonsten werden Standard-Regeln zu Formatierung des Codes eingesetzt. Die eigenen Regeln befinden sich in der Datei \texttt{.scalafmt.conf}. Für dieses Projekt wird das \emph{neo-sbt-scalafmt}-Plugin\footnote{Weitere Informationen zu dem Projekt findet man unter \url{https://github.com/lucidsoftware/neo-sbt-scalafmt}} eingesetzt.

Sollte der Bot mit einer IDE weiterentwickelt werden, so empfiehlt es sich ein Plugin zur automatischen Formatierung mit Scalafmt einzusetzen\footnote{Für die bisherige Entwicklung wurde IntelliJ eingesetzt, hierfür kann das Scalafmt Plugin von Olafur Pall Geirsson eingesetzt werden: \url{https://github.com/scalameta/scalafmt}}. Alternativ kann das Programm über die Kommandozeile in der SBT Shell (also über den SBT Server) ausgeführt werden:

\begin{lstlisting}
sbt:IWINewsBot> scalafmt
\end{lstlisting}

\section{Bot starten}
Nachdem nun die wichtigen Technologien vorgestellt wurden, soll erklärt werden, welche Schritte notwendig sind, damit der Bot gestartet werden kann.

Scala setzt auf die JVM als Laufzeitumgebung, weswegen es wichtig ist, dass ein JDK installiert ist, da die Software nicht nur lauffähig sein soll, sondern auch gebaut und gebündelt werden soll.

Um den Bot starten zu können, muss ein Bot bei Telegram erstellt werden, über den BotFather. Hier erhält man dann im Anschluss das Token. Nun erstellt man im Hauptprojektordner (dem Ordner, in dem sich auch die \texttt{build.sbt}) eine neue Datei \texttt{bot.token} in der man das Token ohne nachfolgende Leerzeichen speichert.

Damit der Bot ohne Fehler starten kann, muss eine Redis Instanz gestartet werden, auf dem Port 6379, was der Standardport für Redis ist. Bei Redis handelt es sich um eine sehr einfach gehaltene In-Memory Datenbank mit Persistenzmöglichkeit. Der Redis-Server wird über den Befehl

\begin{lstlisting}
> redis-server
\end{lstlisting}

gestartet.

Über den bereits besprochenen Befehl \texttt{sbt run} kann der Bot dann gestartet werden.

\section{Projektstruktur}
Das eigentliche Projekt befindet sich unter \texttt{src/}, wobei unter Projektcode (in dem Unterordner \texttt{main/}) und Testcode (in dem Unterordner \texttt{test/}) unterschieden wird. Wie auch bei Java werden in Scala Packages genutzt um Namespaces nachzubilden. Somit ist es möglich Klassen mit gleichen Namen in einem Projekt zu nutzen. Für den Telegram-Bot wurde das Package \texttt{hska.iwi.telegramBot} gewählt. In diesem Package liegen direkt die Main-Klasse \texttt{IWINewsBot}, welche den Bot startet (siehe~\autoref{sec:Programmstart}).

Der Bot kommuniziert auf 2 Arten mit dem Nutzer. Zum einen kann der Nutzer den Bot über bestimmte Befehle direkt ansprechen, worauf dieser dann antwortet. Zum anderen verschickt der Bot automatisch Nachrichten an alle Subscriber, falls es neue Nachrichten gibt.

Für den ersten Fall gibt es die Klassen in dem Package \texttt{hska\allowbreak.iwi\allowbreak.telegramBot\allowbreak.commands}, bei denen definiert wird, wie reagiert wird, wenn ein bestimmter Befehl an den Bot geschickt wird, wobei Befehle mit ein Slash beginnen müssen. Hierbei kann es sich um öffentliche Befehle handeln, also Befehle, die dem BotFather mitgeteilt werden, damit dieser die Befehle vorschlagen kann, es ist aber auch möglich, auf Befehle zu reagieren, die dem BotFather nicht bekannt gemacht wurden. Dies wurde vor allem während der Entwicklung genutzt um bestimmte Funktionalitäten zu nutzen, die noch nicht ganz fertig waren, beispielsweise dem Setzen von Einstellungen, als die Inline-Buttons für diese Funktion noch nicht fertig implementiert waren.

Neben den Commands wird im Hintergrund der Fakultätsserver regelmäßig nach neuen Nachrichten abgefragt. Hierfür existiert die Klasse \texttt{BackgroundFeedSync}, die einen Actor\footnote{Actors sind eine moderne Abstraktionsschicht für nebenläufiges Verhalten, für mehr Informationen siehe: \url{http://danielwestheide.com/blog/2013/02/27/the-neophytes-guide-to-scala-part-14-the-actor-approach-to-concurrency.html}} startet, der im Hintergrund die Fakultätsserver abfragt, auf die Datenbank zugreift und im Falle einer neuen Nachricht die jeweiligen Subscriber benachrichtigt.

Die Ergebnisse der REST-Abfragen sind als JSON kodiert. Zur Deserialisierung werden Case-Klassen eingesetzt, die mithilfe von der \emph{JSON4S}- und \emph{Jackson}-Bibliothek gefüllt werden. Diese Case-Klassen befinden sich in verschiedenen Unterpackages, beispielsweise \texttt{mensa}, \texttt{news} oder \texttt{rooms}.

Zuletzt gibt es das Unterpackage \texttt{service} in der allerlei Helferklassen zusammengefasst werden. Neben der Auslagerung der einzelnen Web-Adressen der Fakultät wird dort die Datenbankanbindung und Wrapper für die HTTP-Requests gespeichert.

\subsection{Main Klasse}\label{sec:Programmstart}

\subsection{Start und Stop Befehle}\label{sec:StartStopCommands}
